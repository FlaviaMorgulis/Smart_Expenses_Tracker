{% extends "base.html" %} {% block title %}Budget - SmartExpensesTracker{%
endblock %} {% block page_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/budget.css') }}"
/>
{% endblock %} {% block content %}
<div class="dashboard-container">
  <div class="dashboard-content">
    <!-- Page Header -->
    <div class="welcome-section">
      <h1>Budget Management ðŸ’°</h1>
      <p class="lead">Track and manage your spending budgets</p>
    </div>

    <!-- Budget Overview Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ðŸŽ¯</div>
        <div class="stat-info">
          <h3>TOTAL BUDGET</h3>
          <h2 class="stat-amount">
            Â£{{ "%.2f"|format(total_budget or 2500) }}
          </h2>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ðŸ’¸</div>
        <div class="stat-info">
          <h3>SPENT THIS MONTH</h3>
          <h2 class="stat-amount negative">
            Â£{{ "%.2f"|format(monthly_spent or 1850) }}
          </h2>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ðŸ’³</div>
        <div class="stat-info">
          <h3>REMAINING</h3>
          <h2
            class="stat-amount {% if (total_budget or 2500) - (monthly_spent or 1850) > 0 %}positive{% else %}negative{% endif %}"
          >
            Â£{{ "%.2f"|format((total_budget or 2500) - (monthly_spent or 1850))
            }}
          </h2>
        </div>
      </div>
    </div>

    <!-- Budget Chart Section -->
    <div class="budget-chart-section">
      <div class="chart-container">
        <div class="budget-donut-chart">
          <h3>Budget Overview</h3>
          <div class="donut-wrapper">
            <div
              class="donut-chart"
              data-spent="{{ monthly_spent or 1850 }}"
              data-total="{{ total_budget or 2500 }}"
            >
              <div class="donut-center">
                <div class="center-text">
                  <span class="percentage"
                    >{{ ((monthly_spent or 1850) / (total_budget or 2500) *
                    100)|round }}%</span
                  >
                  <span class="label">Used</span>
                </div>
              </div>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <div class="legend-color spent"></div>
                <span>Spent: Â£{{ "%.0f"|format(monthly_spent or 1850) }}</span>
              </div>
              <div class="legend-item">
                <div class="legend-color remaining"></div>
                <span
                  >Remaining: Â£{{ "%.0f"|format((total_budget or 2500) -
                  (monthly_spent or 1850)) }}</span
                >
              </div>
            </div>
          </div>
        </div>

        <div class="budget-trend-chart">
          <h3>6-Month Spending Trend</h3>
          <div class="mini-chart">
            <div class="chart-bars">
              {% if monthly_trends %} {% for trend in monthly_trends %}
              <div
                class="bar {% if loop.last %}current{% endif %}"
                style="height: {% set percentage = (trend.spent / (trend.budget if trend.budget > 0 else 1000) * 100) %}{{ percentage if percentage <= 100 else 100 }}%"
                title="{{ trend.month }}: Â£{{ '%.0f'|format(trend.spent) }}"
              ></div>
              {% endfor %} {% else %}
              <!-- Fallback static data -->
              <div
                class="bar"
                style="height: 60%"
                title="Month 1: Â£1,200"
              ></div>
              <div
                class="bar"
                style="height: 75%"
                title="Month 2: Â£1,500"
              ></div>
              <div class="bar" style="height: 45%" title="Month 3: Â£900"></div>
              <div
                class="bar"
                style="height: 80%"
                title="Month 4: Â£1,600"
              ></div>
              <div
                class="bar current"
                style="height: 74%"
                title="Current: Â£1,850"
              ></div>
              <div class="bar" style="height: 0%" title="Future"></div>
              {% endif %}
            </div>
            <div class="chart-labels">
              {% if monthly_trends %} {% for trend in monthly_trends %}
              <span>{{ trend.month }}</span>
              {% endfor %} {% else %}
              <span>M-5</span>
              <span>M-4</span>
              <span>M-3</span>
              <span>M-2</span>
              <span>M-1</span>
              <span>Now</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Budget Progress -->
    <div class="budget-progress-section">
      <div class="monthly-card">
        <h3>Monthly Budget Progress - {{ current_month or 'May 2024' }}</h3>
        <div class="progress-overview">
          <div class="progress-bar">
            <div
              class="progress-fill {% if budget_percentage > 100 %}over-budget{% endif %}"
              style="width: {% set percentage = budget_percentage or ((monthly_spent or 1850) / (total_budget or 2500) * 100) %}{{ percentage if percentage <= 100 else 100 }}%"
            ></div>
          </div>
          <div class="progress-info">
            <span
              >{{ "%.1f"|format(budget_percentage or ((monthly_spent or 1850) /
              (total_budget or 2500) * 100)) }}% used</span
            >
            <span>15 days remaining</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Budget Alerts -->
    {% if budget_alerts %}
    <div class="budget-alerts-section">
      <div class="alerts-card">
        <h3><i class="fas fa-exclamation-triangle"></i> Budget Alerts</h3>
        {% for alert in budget_alerts %}
        <div class="alert-item">
          <div class="alert-icon">âš ï¸</div>
          <div class="alert-content">
            <div class="alert-title">
              {{ alert.category_name }} - Over Budget
            </div>
            <div class="alert-details">
              <span>Spent: Â£{{ "%.2f"|format(alert.spent) }}</span>
              <span>Budget: Â£{{ "%.2f"|format(alert.budget_amount) }}</span>
              <span class="percentage"
                >{{ "%.1f"|format(alert.percentage_used) }}%</span
              >
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Category Breakdown -->
    {% if category_spending %}
    <div class="category-breakdown-section">
      <div class="breakdown-header">
        <h3><i class="fas fa-chart-pie"></i> Category Breakdown</h3>
        <p>Detailed view of spending across different categories</p>
      </div>

      <div class="category-grid">
        {% for category_name, data in category_spending.items() %}
        <div
          class="category-budget-card {% if data.is_over_budget %}over-budget{% endif %}"
        >
          <div class="category-header">
            <h4>{{ category_name }}</h4>
            <div class="category-actions">
              {% if data.is_over_budget %}
              <span class="over-budget-badge">Over Budget!</span>
              {% endif %}
              <button
                class="btn-edit"
                onclick="editBudget('{{ category_name }}', {{ data.budget }})"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn-delete"
                onclick="deleteBudget('{{ category_name }}')"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <div class="category-amounts">
            <div class="amount-row">
              <span class="label">Budget:</span>
              <span class="value">Â£{{ "%.2f"|format(data.budget) }}</span>
            </div>
            <div class="amount-row">
              <span class="label">Spent:</span>
              <span class="value spent">Â£{{ "%.2f"|format(data.spent) }}</span>
            </div>
            <div class="amount-row">
              <span class="label">Remaining:</span>
              <span
                class="value {% if data.remaining < 0 %}negative{% else %}positive{% endif %}"
                >Â£{{ "%.2f"|format(data.remaining) }}</span
              >
            </div>
          </div>

          <div class="category-progress">
            <div class="progress-bar">
              <div
                class="progress-fill {% if data.percentage > 100 %}over-budget{% endif %}"
                style="width: {{ data.percentage if data.percentage <= 100 else 100 }}%"
              ></div>
            </div>
            <div class="progress-text">
              {{ "%.1f"|format(data.percentage) }}% of budget used
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Create Budget Form -->
    <div class="add-transaction-card">
      <h3>Set Category Budget</h3>
      <form id="budgetForm">
        <div class="form-row">
          <div class="input-group">
            <label>Category</label>
            <select class="form-select" required>
              <option value="">Select category</option>
              <option value="food">Food & Dining</option>
              <option value="transport">Transport</option>
              <option value="entertainment">Entertainment</option>
              <option value="shopping">Shopping</option>
              <option value="utilities">Utilities</option>
              <option value="healthcare">Healthcare</option>
            </select>
          </div>

          <div class="input-group">
            <label>Monthly Limit</label>
            <input
              type="number"
              class="form-input"
              placeholder="0.00"
              step="0.01"
              required
            />
          </div>
        </div>

        <div class="form-row">
          <div class="input-group">
            <label>Alert Threshold (%)</label>
            <select class="form-select">
              <option value="50">50%</option>
              <option value="75" selected>75%</option>
              <option value="80">80%</option>
              <option value="90">90%</option>
            </select>
          </div>

          <div class="input-group">
            <label>Period</label>
            <select class="form-select">
              <option value="monthly" selected>Monthly</option>
              <option value="weekly">Weekly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
        </div>

        <button type="submit" class="btn primary">Create Budget</button>
      </form>
    </div>

    <!-- Budget Categories List -->
    <div class="transactions-list">
      <div class="list-header">
        <h3>Category Budgets</h3>
        <div class="list-actions">
          <div class="export-dropdown">
            <button
              class="btn secondary small export-toggle"
              onclick="toggleExportMenu()"
            >
              <i class="fas fa-download"></i> Export Report
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="export-menu" id="exportMenu">
              <button class="export-option" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> Export as PDF
              </button>
              <button class="export-option" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> Export as CSV
              </button>
              <button class="export-option" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export as Excel
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Food & Dining Budget -->
      <div class="budget-item">
        <div class="budget-category">
          <div class="category-icon">ðŸ½ï¸</div>
          <div class="category-info">
            <div class="category-name">Food & Dining</div>
            <div class="category-period">Monthly limit</div>
          </div>
        </div>
        <div class="budget-progress">
          <div class="progress-bar small">
            <div class="progress-fill" style="width: 68%"></div>
          </div>
          <div class="progress-text">68% used</div>
        </div>
        <div class="budget-amounts">
          <div class="spent-amount">Â£340</div>
          <div class="total-amount">/ Â£500</div>
        </div>
        <div class="budget-status">
          <span class="status-badge warning">âš ï¸ Alert</span>
        </div>
      </div>

      <!-- Transport Budget -->
      <div class="budget-item">
        <div class="budget-category">
          <div class="category-icon">ðŸš—</div>
          <div class="category-info">
            <div class="category-name">Transport</div>
            <div class="category-period">Monthly limit</div>
          </div>
        </div>
        <div class="budget-progress">
          <div class="progress-bar small">
            <div class="progress-fill" style="width: 45%"></div>
          </div>
          <div class="progress-text">45% used</div>
        </div>
        <div class="budget-amounts">
          <div class="spent-amount">Â£135</div>
          <div class="total-amount">/ Â£300</div>
        </div>
        <div class="budget-status">
          <span class="status-badge good">âœ… Good</span>
        </div>
      </div>

      <!-- Entertainment Budget -->
      <div class="budget-item">
        <div class="budget-category">
          <div class="category-icon">ðŸŽ¬</div>
          <div class="category-info">
            <div class="category-name">Entertainment</div>
            <div class="category-period">Monthly limit</div>
          </div>
        </div>
        <div class="budget-progress">
          <div class="progress-bar small">
            <div class="progress-fill danger" style="width: 92%"></div>
          </div>
          <div class="progress-text">92% used</div>
        </div>
        <div class="budget-amounts">
          <div class="spent-amount">Â£184</div>
          <div class="total-amount">/ Â£200</div>
        </div>
        <div class="budget-status">
          <span class="status-badge danger">ðŸš¨ Over</span>
        </div>
      </div>

      <!-- Shopping Budget -->
      <div class="budget-item">
        <div class="budget-category">
          <div class="category-icon">ðŸ›ï¸</div>
          <div class="category-info">
            <div class="category-name">Shopping</div>
            <div class="category-period">Monthly limit</div>
          </div>
        </div>
        <div class="budget-progress">
          <div class="progress-bar small">
            <div class="progress-fill" style="width: 23%"></div>
          </div>
          <div class="progress-text">23% used</div>
        </div>
        <div class="budget-amounts">
          <div class="spent-amount">Â£92</div>
          <div class="total-amount">/ Â£400</div>
        </div>
        <div class="budget-status">
          <span class="status-badge good">âœ… Good</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Budget Analytics Section -->
<div class="budget-analytics-section">
  <div class="section-header">
    <h2>ðŸ“Š Budget Analytics</h2>
    <p>Insights and trends for your spending patterns</p>
  </div>

  <div class="analytics-grid">
    <!-- Spending Trends Card -->
    <div class="analytics-card">
      <h3><i class="fas fa-chart-line"></i> Spending Trends</h3>
      <div class="trend-chart">
        <div class="trend-month">
          <div class="month-label">Oct</div>
          <div class="trend-bar">
            <div class="trend-bar-fill" style="height: 70%"></div>
          </div>
          <div class="trend-amount">Â£1,750</div>
        </div>
        <div class="trend-month">
          <div class="month-label">Nov</div>
          <div class="trend-bar">
            <div class="trend-bar-fill current" style="height: 85%"></div>
          </div>
          <div class="trend-amount">Â£2,125</div>
        </div>
        <div class="trend-month">
          <div class="month-label">Dec</div>
          <div class="trend-bar">
            <div class="trend-bar-fill projected" style="height: 60%"></div>
          </div>
          <div class="trend-amount">Â£1,500</div>
        </div>
      </div>
      <div class="trend-insights">
        <div class="insight-item">
          <span class="insight-label">Trend:</span>
          <span class="insight-value increase">ðŸ“ˆ +21% vs last month</span>
        </div>
      </div>
    </div>

    <!-- Category Performance Card -->
    <div class="analytics-card">
      <h3><i class="fas fa-target"></i> Category Performance</h3>
      <div class="performance-list">
        <div class="performance-item good">
          <div class="performance-category">
            <span class="category-icon">ðŸ›ï¸</span>
            <span class="category-name">Shopping</span>
          </div>
          <div class="performance-score">
            <span class="score-badge good">98%</span>
            <span class="score-label">Under Budget</span>
          </div>
        </div>
        <div class="performance-item warning">
          <div class="performance-category">
            <span class="category-icon">ðŸ½ï¸</span>
            <span class="category-name">Food & Dining</span>
          </div>
          <div class="performance-score">
            <span class="score-badge warning">89%</span>
            <span class="score-label">Near Limit</span>
          </div>
        </div>
        <div class="performance-item danger">
          <div class="performance-category">
            <span class="category-icon">ðŸŽ¬</span>
            <span class="category-name">Entertainment</span>
          </div>
          <div class="performance-score">
            <span class="score-badge danger">115%</span>
            <span class="score-label">Over Budget</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Budget Predictions Card -->
    <div class="analytics-card">
      <h3><i class="fas fa-crystal-ball"></i> Monthly Forecast</h3>
      <div class="prediction-content">
        <div class="prediction-main">
          <div class="prediction-amount">Â£2,450</div>
          <div class="prediction-label">Projected spending</div>
          <div class="prediction-confidence">
            <span class="confidence-badge">78% confidence</span>
          </div>
        </div>
        <div class="prediction-breakdown">
          <div class="prediction-item">
            <span class="prediction-category">Entertainment</span>
            <span class="prediction-risk danger">High risk</span>
          </div>
          <div class="prediction-item">
            <span class="prediction-category">Food & Dining</span>
            <span class="prediction-risk warning">Medium risk</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Budget Modal -->
<div class="budget-goals-section">
  <div class="section-header">
    <h2>ðŸŽ¯ Budget Goals</h2>
    <p>Set and track your savings and spending goals</p>
  </div>

  <div class="goals-grid">
    <!-- Emergency Fund Goal -->
    <div class="goal-card">
      <div class="goal-header">
        <div class="goal-info">
          <h3><i class="fas fa-umbrella"></i> Emergency Fund</h3>
          <p>Build 3-month expense buffer</p>
        </div>
        <div class="goal-status active">Active</div>
      </div>
      <div class="goal-progress">
        <div class="goal-amounts">
          <span class="current-amount">Â£1,200</span>
          <span class="target-amount">/ Â£3,000</span>
        </div>
        <div class="progress-bar large">
          <div class="progress-fill" style="width: 40%"></div>
        </div>
        <div class="progress-details">
          <span class="progress-percentage">40% complete</span>
          <span class="time-remaining">8 months to go</span>
        </div>
      </div>
      <div class="goal-actions">
        <button class="btn secondary small">Adjust Goal</button>
        <button class="btn primary small">Add Funds</button>
      </div>
    </div>

    <!-- Vacation Savings Goal -->
    <div class="goal-card">
      <div class="goal-header">
        <div class="goal-info">
          <h3><i class="fas fa-plane"></i> Vacation Fund</h3>
          <p>Summer 2025 trip to Italy</p>
        </div>
        <div class="goal-status active">Active</div>
      </div>
      <div class="goal-progress">
        <div class="goal-amounts">
          <span class="current-amount">Â£650</span>
          <span class="target-amount">/ Â£2,000</span>
        </div>
        <div class="progress-bar large">
          <div class="progress-fill" style="width: 32.5%"></div>
        </div>
        <div class="progress-details">
          <span class="progress-percentage">32.5% complete</span>
          <span class="time-remaining">6 months to go</span>
        </div>
      </div>
      <div class="goal-actions">
        <button class="btn secondary small">Adjust Goal</button>
        <button class="btn primary small">Add Funds</button>
      </div>
    </div>

    <!-- New Goal Card -->
    <div class="goal-card add-goal">
      <div class="add-goal-content">
        <div class="add-goal-icon">âž•</div>
        <h3>Create New Goal</h3>
        <p>Set a new savings or spending target</p>
        <button class="btn primary" onclick="showAddGoalForm()">
          Add Goal
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions Section -->
<div class="quick-actions-section">
  <div class="section-header">
    <h2>âš¡ Quick Actions</h2>
    <p>Common budget management tasks</p>
  </div>

  <div class="actions-grid">
    <div class="action-card" onclick="setMonthlyAllowance()">
      <div class="action-icon">ðŸ’°</div>
      <div class="action-content">
        <h3>Set Monthly Allowance</h3>
        <p>Quick setup for total monthly spending limit</p>
      </div>
      <div class="action-arrow">â†’</div>
    </div>

    <div class="action-card" onclick="adjustAllCategories()">
      <div class="action-icon">âš–ï¸</div>
      <div class="action-content">
        <h3>Balance Categories</h3>
        <p>Automatically adjust category budgets</p>
      </div>
      <div class="action-arrow">â†’</div>
    </div>

    <div class="action-card" onclick="copyLastMonth()">
      <div class="action-icon">ðŸ“‹</div>
      <div class="action-content">
        <h3>Copy Last Month</h3>
        <p>Use previous month's budget as template</p>
      </div>
      <div class="action-arrow">â†’</div>
    </div>

    <div class="action-card" onclick="resetAllBudgets()">
      <div class="action-icon">ðŸ”„</div>
      <div class="action-content">
        <h3>Reset Budgets</h3>
        <p>Start fresh with new budget allocations</p>
      </div>
      <div class="action-arrow">â†’</div>
    </div>

    <div class="action-card" onclick="showBudgetTips()">
      <div class="action-icon">ðŸ’¡</div>
      <div class="action-content">
        <h3>Budget Tips</h3>
        <p>Get personalized budgeting advice</p>
      </div>
      <div class="action-arrow">â†’</div>
    </div>

    <div class="action-card" onclick="scheduleReview()">
      <div class="action-icon">ðŸ“…</div>
      <div class="action-content">
        <h3>Schedule Review</h3>
        <p>Set up weekly/monthly budget check-ins</p>
      </div>
      <div class="action-arrow">â†’</div>
    </div>
  </div>
</div>

<!-- Edit Budget Modal -->
<div id="editBudgetModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Budget</h3>
      <span class="modal-close" onclick="closeEditModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editBudgetForm">
        <div class="form-row">
          <div class="input-group">
            <label>Category</label>
            <input
              type="text"
              id="editCategoryName"
              class="form-input"
              readonly
            />
          </div>
          <div class="input-group">
            <label>Monthly Limit</label>
            <input
              type="number"
              id="editBudgetAmount"
              class="form-input"
              step="0.01"
              required
            />
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label>Alert Threshold (%)</label>
            <select id="editAlertThreshold" class="form-select">
              <option value="50">50%</option>
              <option value="75">75%</option>
              <option value="80">80%</option>
              <option value="90">90%</option>
            </select>
          </div>
          <div class="input-group">
            <label>Status</label>
            <select id="editBudgetStatus" class="form-select">
              <option value="active">Active</option>
              <option value="paused">Paused</option>
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button
            type="button"
            class="btn secondary"
            onclick="closeEditModal()"
          >
            Cancel
          </button>
          <button type="submit" class="btn primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Edit and Delete Functions
  function editBudget(categoryName, currentAmount) {
    document.getElementById("editCategoryName").value = categoryName;
    document.getElementById("editBudgetAmount").value = currentAmount;
    document.getElementById("editBudgetModal").style.display = "block";
  }

  function deleteBudget(categoryName) {
    if (confirm(`Are you sure you want to delete the ${categoryName} budget?`)) {
      alert(`${categoryName} budget deleted successfully!`);
      // Here you would normally make an AJAX call to delete the budget
      location.reload();
    }
  }

  function closeEditModal() {
    document.getElementById("editBudgetModal").style.display = "none";
  }

  // Close modal when clicking outside
  window.onclick = function (event) {
    const modal = document.getElementById("editBudgetModal");
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  // Handle budget form submission (existing form)
  document
    .getElementById("budgetForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      // Here you would typically make an AJAX call to create the budget
      alert("Budget created successfully!");
      location.reload();
    });

  // Handle edit form submission
  document
    .getElementById("editBudgetForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const categoryName = document.getElementById("editCategoryName").value;
      const newAmount = document.getElementById("editBudgetAmount").value;
      const alertThreshold =
        document.getElementById("editAlertThreshold").value;
      const status = document.getElementById("editBudgetStatus").value;

      // Here you would normally make an AJAX call to update the budget
      alert(
        `Budget updated: ${categoryName} - Â£${newAmount} (${alertThreshold}% alert)`
      );
      closeEditModal();
      location.reload();
    });

  // Export Functionality
  function toggleExportMenu() {
    const menu = document.getElementById("exportMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  function exportToPDF() {
    // Generate PDF report
    const budgetData = collectBudgetData();

    // Create a printable version
    const printContent = generateBudgetReport(budgetData);
    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
      <html>
        <head>
          <title>Budget Report - SmartExpensesTracker</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
            .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; }
            .category-item { border-bottom: 1px solid #eee; padding: 15px 0; }
            .progress-bar { width: 100%; height: 20px; background: #f0f0f0; margin: 10px 0; }
            .progress-fill { height: 100%; background: #007bff; }
            .over-budget { background: #dc3545 !important; }
          </style>
        </head>
        <body>
          \${printContent}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
    closeExportMenu();
  }

  function exportToCSV() {
    const budgetData = collectBudgetData();
    let csvContent = "Category,Budget,Spent,Remaining,Percentage Used,Status\n";

    budgetData.categories.forEach((category) => {
      csvContent += `"\${category.name}",\${category.budget},\${category.spent},\${category.remaining},\${category.percentage},"\${category.status}"\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      `budget_report_\${new Date().toISOString().split("T")[0]}.csv`
    );
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    closeExportMenu();
  }

  function exportToExcel() {
    // For Excel export, we'll use CSV format with .xlsx extension
    // In a real application, you might use a library like SheetJS
    const budgetData = collectBudgetData();
    let csvContent = "Category,Budget,Spent,Remaining,Percentage Used,Status\n";

    budgetData.categories.forEach((category) => {
      csvContent += `"\${category.name}",\${category.budget},\${category.spent},\${category.remaining},\${category.percentage},"\${category.status}"\n`;
    });

    const blob = new Blob([csvContent], {
      type: "application/vnd.ms-excel;charset=utf-8;",
    });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      `budget_report_\${new Date().toISOString().split("T")[0]}.xlsx`
    );
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    closeExportMenu();
  }

  function collectBudgetData() {
    // Collect data from the current page (this would typically come from your backend)
    const totalBudget = parseFloat("{{ total_budget or 2500 }}");
    const monthlySpent = parseFloat("{{ monthly_spent or 1850 }}");
    const remaining = totalBudget - monthlySpent;

    return {
      summary: {
        totalBudget: totalBudget,
        spent: monthlySpent,
        remaining: remaining,
        percentage: ((monthlySpent / totalBudget) * 100).toFixed(1),
      },
      categories: [
        // Sample data for demonstration - would be populated from backend
        {
          name: "Food & Dining",
          budget: 500,
          spent: 320,
          remaining: 180,
          percentage: 64.0,
          status: "On Track",
        },
        {
          name: "Transport",
          budget: 200,
          spent: 184,
          remaining: 16,
          percentage: 92.0,
          status: "Over Budget",
        },
        {
          name: "Shopping",
          budget: 400,
          spent: 92,
          remaining: 308,
          percentage: 23.0,
          status: "On Track",
        },
        {
          name: "Entertainment",
          budget: 300,
          spent: 280,
          remaining: 20,
          percentage: 93.3,
          status: "Over Budget",
        },
        {
          name: "Health & Fitness",
          budget: 150,
          spent: 45,
          remaining: 105,
          percentage: 30.0,
          status: "On Track",
        },
      ],
    };
  }

  function generateBudgetReport(data) {
    const currentDate = new Date().toLocaleDateString("en-GB");

    return `
      <div class="header">
        <h1>ðŸ’° Budget Report</h1>
        <p>SmartExpensesTracker - Generated on \${currentDate}</p>
      </div>

      <div class="stats">
        <div class="stat-card">
          <h3>TOTAL BUDGET</h3>
          <div class="amount">Â£\${data.summary.totalBudget.toFixed(2)}</div>
        </div>
        <div class="stat-card">
          <h3>SPENT THIS MONTH</h3>
          <div class="amount">Â£\${data.summary.spent.toFixed(2)}</div>
        </div>
        <div class="stat-card">
          <h3>REMAINING</h3>
          <div class="amount">Â£\${data.summary.remaining.toFixed(2)}</div>
        </div>
      </div>

      <div class="categories">
        <h2>Category Breakdown</h2>
        \${data.categories
          .map(
            (category) => `
          <div class="category-item">
            <div class="category-header">
              <span class="category-name">\${category.name}</span>
              <span class="status">\${category.status}</span>
            </div>
            <div class="category-amounts">
              <span>Budget: Â£\${category.budget.toFixed(2)}</span>
              <span>Spent: Â£\${category.spent.toFixed(2)}</span>
              <span>Remaining: Â£\${category.remaining.toFixed(2)}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill \${
                category.percentage > 100 ? "over-budget" : ""
              }"
                   style="width: \${Math.min(category.percentage, 100)}%"></div>
            </div>
            <div>\${category.percentage}% of budget used</div>
          </div>
        `
          )
          .join("")}
      </div>

      <div class="footer">
        <p>Generated by SmartExpensesTracker - Budget Management System</p>
      </div>
    `;
  }

  function closeExportMenu() {
    document.getElementById("exportMenu").style.display = "none";
  }

  // Close export menu when clicking outside
  document.addEventListener("click", function (event) {
    const exportDropdown = document.querySelector(".export-dropdown");
    if (!exportDropdown.contains(event.target)) {
      closeExportMenu();
    }
  });
</script>

{% endblock %}

<script>
  // Budget Management JavaScript
  function editBudget(categoryName, currentAmount) {
    document.getElementById("editCategoryName").value = categoryName;
    document.getElementById("editBudgetAmount").value = currentAmount;
    document.getElementById("editBudgetModal").style.display = "flex";
  }

  function closeEditModal() {
    document.getElementById("editBudgetModal").style.display = "none";
  }

  function deleteBudget(categoryName) {
    if (
      confirm(`Are you sure you want to delete the budget for ${categoryName}?`)
    ) {
      // Here you would typically make an AJAX call to delete the budget
      alert(`Budget for ${categoryName} deleted successfully!`);
      // Reload the page or remove the card from DOM
      location.reload();
    }
  }

  // Handle edit form submission
  document
    .getElementById("editBudgetForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const categoryName = document.getElementById("editCategoryName").value;
      const newAmount = document.getElementById("editBudgetAmount").value;
      const alertThreshold =
        document.getElementById("editAlertThreshold").value;
      const status = document.getElementById("editBudgetStatus").value;

      // Here you would typically make an AJAX call to update the budget
      alert(`Budget for ${categoryName} updated to Â£${newAmount}!`);
      closeEditModal();
      // Reload the page or update the card in DOM
      location.reload();
    });

  // Close modal when clicking outside
  window.addEventListener("click", function (event) {
    const modal = document.getElementById("editBudgetModal");
    if (event.target === modal) {
      closeEditModal();
    }
  });

  // Handle budget form submission (existing form)
  document
    .getElementById("budgetForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      // Here you would typically make an AJAX call to create the budget
      alert("Budget created successfully!");
      location.reload();
    });

  // Export Functionality
  function toggleExportMenu() {
    const menu = document.getElementById("exportMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  function exportToPDF() {
    // Generate PDF report
    const budgetData = collectBudgetData();

    // Create a printable version
    const printContent = generateBudgetReport(budgetData);
    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
      <html>
        <head>
          <title>Budget Report - SmartExpensesTracker</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
            .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; }
            .category-item { border-bottom: 1px solid #eee; padding: 15px 0; }
            .progress-bar { width: 100%; height: 20px; background: #f0f0f0; margin: 10px 0; }
            .progress-fill { height: 100%; background: #007bff; }
            .over-budget { background: #dc3545 !important; }
          </style>
        </head>
        <body>
          ${printContent}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
    closeExportMenu();
  }

  function exportToCSV() {
    const budgetData = collectBudgetData();
    let csvContent = "Category,Budget,Spent,Remaining,Percentage Used,Status\n";

    budgetData.categories.forEach((category) => {
      csvContent += `"${category.name}",${category.budget},${category.spent},${category.remaining},${category.percentage},"${category.status}"\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      `budget_report_${new Date().toISOString().split("T")[0]}.csv`
    );
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    closeExportMenu();
  }

  function exportToExcel() {
    // For Excel export, we'll use CSV format with .xlsx extension
    // In a real application, you might use a library like SheetJS
    const budgetData = collectBudgetData();
    let csvContent = "Category,Budget,Spent,Remaining,Percentage Used,Status\n";

    budgetData.categories.forEach((category) => {
      csvContent += `"${category.name}",${category.budget},${category.spent},${category.remaining},${category.percentage},"${category.status}"\n`;
    });

    const blob = new Blob([csvContent], {
      type: "application/vnd.ms-excel;charset=utf-8;",
    });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      `budget_report_${new Date().toISOString().split("T")[0]}.xlsx`
    );
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    closeExportMenu();
  }

  function collectBudgetData() {
    // Collect data from the current page (this would typically come from your backend)
    const totalBudget = parseFloat("{{ total_budget or 2500 }}");
    const monthlySpent = parseFloat("{{ monthly_spent or 1850 }}");
    const remaining = totalBudget - monthlySpent;

    return {
      summary: {
        totalBudget: totalBudget,
        spent: monthlySpent,
        remaining: remaining,
        percentage: ((monthlySpent / totalBudget) * 100).toFixed(1),
      },
      categories: [
        // Sample data for demonstration - would be populated from backend
        {
          name: "Food & Dining",
          budget: 500,
          spent: 320,
          remaining: 180,
          percentage: 64.0,
          status: "On Track",
        },
        {
          name: "Transport",
          budget: 200,
          spent: 184,
          remaining: 16,
          percentage: 92.0,
          status: "Over Budget",
        },
        {
          name: "Shopping",
          budget: 400,
          spent: 92,
          remaining: 308,
          percentage: 23.0,
          status: "On Track",
        },
        {
          name: "Entertainment",
          budget: 300,
          spent: 280,
          remaining: 20,
          percentage: 93.3,
          status: "Over Budget",
        },
        {
          name: "Health & Fitness",
          budget: 150,
          spent: 45,
          remaining: 105,
          percentage: 30.0,
          status: "On Track",
        },
      ],
    };
  }

  function generateBudgetReport(data) {
    const currentDate = new Date().toLocaleDateString("en-GB");

    return `
      <div class="header">
        <h1>ðŸ’° Budget Report</h1>
        <p>SmartExpensesTracker - Generated on ${currentDate}</p>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <h3>TOTAL BUDGET</h3>
          <div class="amount">Â£${data.summary.totalBudget.toFixed(2)}</div>
        </div>
        <div class="stat-card">
          <h3>SPENT THIS MONTH</h3>
          <div class="amount">Â£${data.summary.spent.toFixed(2)}</div>
        </div>
        <div class="stat-card">
          <h3>REMAINING</h3>
          <div class="amount">Â£${data.summary.remaining.toFixed(2)}</div>
        </div>
      </div>
      
      <div class="categories">
        <h2>Category Breakdown</h2>
        ${data.categories
          .map(
            (category) => `
          <div class="category-item">
            <div class="category-header">
              <span class="category-name">${category.name}</span>
              <span class="status">${category.status}</span>
            </div>
            <div class="category-amounts">
              <span>Budget: Â£${category.budget.toFixed(2)}</span>
              <span>Spent: Â£${category.spent.toFixed(2)}</span>
              <span>Remaining: Â£${category.remaining.toFixed(2)}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill ${
                category.percentage > 100 ? "over-budget" : ""
              }" 
                   style="width: ${Math.min(category.percentage, 100)}%"></div>
            </div>
            <div>${category.percentage}% of budget used</div>
          </div>
        `
          )
          .join("")}
      </div>
      
      <div class="footer">
        <p>Generated by SmartExpensesTracker - Budget Management System</p>
      </div>
    `;
  }

  function closeExportMenu() {
    document.getElementById("exportMenu").style.display = "none";
  }

  // Close export menu when clicking outside
  document.addEventListener("click", function (event) {
    const exportDropdown = document.querySelector(".export-dropdown");
    if (!exportDropdown.contains(event.target)) {
      closeExportMenu();
    }
  });

  // Quick Action Functions
  function setMonthlyAllowance() {
    const amount = prompt("Enter your total monthly spending limit:");
    if (amount && !isNaN(amount) && amount > 0) {
      alert(`Monthly allowance set to Â£${parseFloat(amount).toFixed(2)}`);
      // Here you would normally send this to the backend
      console.log(`Setting monthly allowance to Â£${amount}`);
    }
  }

  function adjustAllCategories() {
    const totalBudget = prompt(
      "Enter your total monthly budget to distribute:"
    );
    if (totalBudget && !isNaN(totalBudget) && totalBudget > 0) {
      alert(
        `Automatically adjusting category budgets based on Â£${parseFloat(
          totalBudget
        ).toFixed(2)} total budget`
      );
      // Here you would normally call backend to redistribute budgets
      console.log(`Redistributing Â£${totalBudget} across categories`);
    }
  }

  function copyLastMonth() {
    if (confirm("Copy all budget amounts from last month to this month?")) {
      alert("Last month's budget copied successfully!");
      // Here you would normally call backend to copy previous budgets
      console.log("Copying last month's budgets");
      location.reload();
    }
  }

  function resetAllBudgets() {
    if (
      confirm(
        "Are you sure you want to reset all budget amounts? This cannot be undone."
      )
    ) {
      alert("All budgets have been reset to Â£0");
      // Here you would normally call backend to reset budgets
      console.log("Resetting all budgets");
      location.reload();
    }
  }

  function showBudgetTips() {
    const tips = [
      "ðŸ’¡ Tip: Allocate 50% for needs, 30% for wants, and 20% for savings",
      "ðŸ’¡ Tip: Review and adjust your budgets monthly based on spending patterns",
      "ðŸ’¡ Tip: Set alerts at 75% of your budget to avoid overspending",
      "ðŸ’¡ Tip: Use the 'envelope method' - when a category is spent, stop spending in that category",
      "ðŸ’¡ Tip: Track your spending weekly to stay on top of your budget",
    ];
    const randomTip = tips[Math.floor(Math.random() * tips.length)];
    alert(randomTip);
  }

  function scheduleReview() {
    const frequency = prompt(
      "How often would you like budget review reminders?\n1. Weekly\n2. Monthly\n3. Quarterly\n\nEnter 1, 2, or 3:"
    );
    const frequencies = { 1: "Weekly", 2: "Monthly", 3: "Quarterly" };
    if (frequencies[frequency]) {
      alert(`${frequencies[frequency]} budget review reminders scheduled!`);
      // Here you would normally set up notifications/reminders in the backend
      console.log(`Scheduling ${frequencies[frequency]} reminders`);
    }
  }

  // Budget Goals Functions
  function showAddGoalForm() {
    const goalName = prompt("Enter your savings goal name:");
    if (goalName) {
      const targetAmount = prompt("Enter target amount (Â£):");
      if (targetAmount && !isNaN(targetAmount) && targetAmount > 0) {
        const deadline = prompt("Enter target date (YYYY-MM-DD):");
        if (deadline) {
          alert(
            `Goal "${goalName}" created!\nTarget: Â£${parseFloat(
              targetAmount
            ).toFixed(2)}\nDeadline: ${deadline}`
          );
          // Here you would normally send this to the backend
          console.log(
            `Creating goal: ${goalName}, Â£${targetAmount}, ${deadline}`
          );
        }
      }
    }
  }

  // Enhanced Export Functions with Real Data Integration
  function exportToCSV() {
    // Enhanced CSV export with more detailed data
    let csvContent =
      "Category,Budget Amount,Spent Amount,Remaining,Percentage Used,Status,Alert Threshold\n";

    // In a real implementation, this would fetch actual data from the backend
    const sampleData = [
      {
        name: "Food & Dining",
        budget: 500,
        spent: 320,
        remaining: 180,
        percentage: 64,
        status: "Good",
        threshold: 75,
      },
      {
        name: "Transport",
        budget: 200,
        spent: 184,
        remaining: 16,
        percentage: 92,
        status: "Warning",
        threshold: 75,
      },
      {
        name: "Entertainment",
        budget: 300,
        spent: 345,
        remaining: -45,
        percentage: 115,
        status: "Over Budget",
        threshold: 75,
      },
      {
        name: "Shopping",
        budget: 400,
        spent: 92,
        remaining: 308,
        percentage: 23,
        status: "Good",
        threshold: 75,
      },
      {
        name: "Utilities",
        budget: 150,
        spent: 135,
        remaining: 15,
        percentage: 90,
        status: "Warning",
        threshold: 75,
      },
    ];

    sampleData.forEach((item) => {
      csvContent += `"${item.name}",${item.budget},${item.spent},${item.remaining},${item.percentage},"${item.status}",${item.threshold}\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      `detailed_budget_report_${new Date().toISOString().split("T")[0]}.csv`
    );
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    closeExportMenu();
  }

  // Animation for progress bars on page load
  document.addEventListener("DOMContentLoaded", function () {
    const progressBars = document.querySelectorAll(".progress-fill");
    progressBars.forEach((bar) => {
      const width = bar.style.width;
      bar.style.width = "0%";
      setTimeout(() => {
        bar.style.transition = "width 1.5s ease-in-out";
        bar.style.width = width;
      }, 500);
    });

    // Animate trend bars
    const trendBars = document.querySelectorAll(".trend-bar-fill");
    trendBars.forEach((bar, index) => {
      const height = bar.style.height;
      bar.style.height = "0%";
      setTimeout(() => {
        bar.style.transition = "height 1s ease-in-out";
        bar.style.height = height;
      }, 700 + index * 200);
    });
  });
</script>

{% endblock %}

