{% extends "base.html" %} {% block title %}Family Management -
SmartExpensesTracker{% endblock %} {% block head %}
<!-- Members & Family Management CSS -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/members.css') }}"
/>
<!-- Budget CSS for category cards -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/budget.css') }}"
/>
{% endblock %} {% block content %}

<div class="dashboard-container">
  <!-- Welcome Section -->
  <div class="welcome-section" style="display: flex; justify-content: space-between; align-items: center; padding: 30px 0; margin-bottom: 20px;">
    <div class="welcome-content">
      <h1 style="margin-bottom: 8px;">Family Expenses üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h1>
      <p class="lead" style="margin: 0; color: #6c757d;">Shared household tracking and savings goals</p>
    </div>
    <div class="header-actions" style="display: flex; gap: 12px;">
      <button class="btn secondary" data-action="add-member" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; min-width: 140px;">
        Add Member
      </button>
      <button class="btn secondary" data-action="add-expense" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; min-width: 140px;">
        Add Expense
      </button>
      <button class="btn secondary" data-action="manage-budget" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; min-width: 140px;">
        Manage Budget
      </button>
    </div>
  </div>

  <!-- Monthly Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
      <div class="stat-info">
        <h3>FAMILY MEMBERS</h3>
        <h2 class="stat-amount">{{ member_count + 1 }}</h2>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-info">
        <h3>TOTAL EXPENSES</h3>
        <h2 class="stat-amount negative">¬£{{ "%.0f"|format(total_family_expenses) }}</h2>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-info">
        <h3>MONTHLY BUDGET</h3>
        <h2 class="stat-amount">¬£{{ "%.0f"|format(family_budget_total) }}</h2>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-info">
        <h3>BUDGET USED</h3>
        <h2 class="stat-amount {{ 'warning' if budget_percentage >= 75 else 'positive' }}">
          {{ "%.0f"|format(budget_percentage if budget_percentage else 0) }}%
        </h2>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">    <!-- Family Members Section -->
    <div class="members-section">
      <div class="members-header">
        <h3>Family Members</h3>
      </div>
      <div class="members-grid">
        <!-- Current User (Owner) -->
        <div class="member-card owner">
          <div class="member-actions">
            <button
              class="action-btn edit"
              onclick="editProfile()"
                  title="Edit Profile"
                >
                  ‚úèÔ∏è
                </button>
                <button
                  class="action-btn settings"
                  onclick="showSettings()"
                  title="Account Settings"
                >
                  ‚öôÔ∏è
                </button>
              </div>
              <div class="member-header">
                <div class="member-avatar owner-avatar">
                  {{ current_user.user_name[0].upper() if current_user.user_name
                  else 'U' }}
                </div>
                <div class="owner-badge">Owner</div>
              </div>
              <div class="member-info">
                <div class="member-name">
                  {{ current_user.user_name or 'You' }}
                </div>
                <div class="member-role">Account Owner</div>
                <div class="member-stats">
                  <div class="stat">
                    <span class="value"
                      >¬£{{ "%.0f"|format(total_family_expenses * 0.4 if
                      total_family_expenses > 0 else 0) }}</span
                    >
                    <span class="label">Paid</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Family Members -->
            {% for member in members %} {% set stats =
            member.get_lifetime_stats() %}
            <div class="member-card" data-member-id="{{ member.member_id }}">
              <div class="member-actions">
                <button
                  class="action-btn edit"
                  data-action="edit-member"
                  data-member-id="{{ member.member_id }}"
                  data-member-name="{{ member.name|e }}"
                  data-member-relationship="{{ member.relationship|e }}"
                >
                  ‚úèÔ∏è
                </button>
                <button
                  class="action-btn delete"
                  data-action="delete-member"
                  data-member-id="{{ member.member_id }}"
                  data-member-name="{{ member.name|e }}"
                >
                  üóëÔ∏è
                </button>
              </div>
              <div class="member-header">
                <div class="member-avatar">{{ member.name[0].upper() }}</div>
              </div>
              <div class="member-info">
                <div class="member-name">{{ member.name }}</div>
                <div class="member-role">{{ member.relationship }}</div>
                <div class="member-stats">
                  <div class="stat">
                    <span class="value"
                      >¬£{{ "%.0f"|format(stats.total_contribution) }}</span
                    >
                    <span class="label">Contributed</span>
                  </div>
                  <div class="stat">
                    <span class="value">{{ stats.total_transactions }}</span>
                    <span class="label">Expenses</span>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}

            <!-- Add Member Card -->
            <div class="member-card add-member">
              <div class="add-member-content">
                <div class="add-icon">‚ûï</div>
                <div class="add-text">Add Family Member</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Section in Dashboard Style -->
        <div class="analytics-section">
          <!-- Global controls for charts (outside cards) -->
          <div class="chart-controls outside">
            <div class="view-toggle-buttons">
              <button id="wholeFamilyBtn" class="toggle-btn active" data-view="family">Whole Family</button>
              <select id="perMemberSelect" class="toggle-select" data-view="member">
                <option value="" disabled selected>Per Member</option>
                <option value="{{ current_user.user_name or 'You' }}">
                  üè† {{ current_user.user_name or 'You' }} (Owner)
                </option>
                {% for member in members %}
                <option value="{{ member.name }}">üë§ {{ member.name }} ({{ member.relationship }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="analytics-grid">
            <!-- Card 1: Category Spending Over Time -->
            <div class="analytics-card">
              <div class="chart-header">
                <h4>Category Spending Trends</h4>
              </div>
              <div class="chart-container">
                <canvas id="categoryChart" width="400" height="300"></canvas>
              </div>
            </div>

            <!-- Card 2: Category Distribution -->
            <div class="analytics-card">
              <div class="chart-header">
                <h4>Category Distribution</h4>
              </div>
              <div class="chart-container">
                <canvas id="familyMonthlyComparisonChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>

      <!-- Category Budgets Section -->
      <div class="category-budgets-section">
        <div class="section-header">
          <h3>Category Budgets</h3>
          <button
            class="btn secondary"
            data-action="manage-budget"
            onclick="console.log('Inline onclick fired'); showBudgetModal(); return false;"
            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; min-width: 140px;"
          >
            Add Category Budget
          </button>
        </div>
        
        <div class="budget-cards-grid">
          {% if category_budgets %}
            {# Create a list of tuples with category data and sort by percentage (highest first) #}
            {% set budget_list = [] %}
            {% for category_name, budget_amount in category_budgets.items() %}
              {% if budget_amount > 0 %}
                {% set spent = category_expenses.get(category_name, 0) %}
                {% set percentage = (spent / budget_amount * 100) if budget_amount > 0 else 0 %}
                {% set _ = budget_list.append((category_name, budget_amount, spent, percentage)) %}
              {% endif %}
            {% endfor %}
            
            {# Sort by percentage descending (red to green) #}
            {% set sorted_budgets = budget_list|sort(attribute='3', reverse=True) %}
            
            {% for category_name, budget_amount, spent, percentage in sorted_budgets %}
                {% set progress_class = 'critical-level' if percentage >= 90 else ('warning-level' if percentage >= 75 else 'good-level') %}
                {% set alert_class = 'critical' if percentage >= 90 else ('warning' if percentage >= 75 else 'success') %}
                
                <div class="category-card">
                  <div class="category-header">
                    <h3>{{ category_name }}</h3>
                    <div class="category-actions">
                      <button class="btn-icon" onclick="editCategoryBudget('{{ category_name }}', {{ budget_amount }})" title="Edit">‚úèÔ∏è</button>
                      <button class="btn-icon delete" onclick="deleteCategoryBudget('{{ category_name }}')" title="Delete">üóëÔ∏è</button>
                    </div>
                  </div>
                  <div class="category-amount">¬£{{ "%.0f"|format(budget_amount) }}</div>
                  <div class="category-progress">
                    <div class="progress-bar small">
                      <div class="progress-fill {{ progress_class }}" style="width: {{ percentage|round(0) }}%"></div>
                    </div>
                    <div class="progress-text">
                      <span>¬£{{ "%.0f"|format(spent) }} spent</span>
                      <span>{{ "%.0f"|format(percentage) }}%</span>
                    </div>
                  </div>
                  <div class="category-alert {{ alert_class }}">
                    {% if percentage >= 90 %}
                      ‚ö†Ô∏è {{ "%.0f"|format(percentage) }}% - Critical! Near limit!
                    {% elif percentage >= 75 %}
                      ‚ö†Ô∏è {{ "%.0f"|format(percentage) }}% - Monitor spending
                    {% else %}
                      ‚úÖ {{ "%.0f"|format(percentage) }}% - Well managed!
                    {% endif %}
                  </div>
                </div>
            {% endfor %}
          {% else %}
            <p style="color: #6c757d; padding: 20px; text-align: center;">No budgets configured yet. Click "Add Category Budget" to create your first budget.</p>
          {% endif %}
        </div>
      </div>

      <!-- Recent Expenses Section -->
      <div class="expenses-section">
        <div class="expenses-header">
          <h3>Recent Family Expenses</h3>
          <button
            class="btn secondary"
            data-action="add-expense-section"
            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; min-width: 140px;"
          >
            Add Expense
          </button>
        </div>
        <div class="expenses-table-container">
          <table class="expenses-table">
            <thead>
              <tr>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">DATE</th>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">DESCRIPTION</th>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">CATEGORY</th>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">AMOUNT</th>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">PAID BY</th>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">SPLIT BETWEEN</th>
                <th style="text-transform: uppercase; font-size: 12px; font-weight: 600; color: #6c757d; letter-spacing: 0.5px;">ACTIONS</th>
              </tr>
            </thead>
            <tbody>
              {% for expense in recent_shared_expenses %}
              <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 16px 12px; color: #2c3e50;">{{ expense.date }}</td>
                <td style="padding: 16px 12px; color: #2c3e50;">{{ expense.description or 'Family Expense' }}</td>
                <td style="padding: 16px 12px; color: #d9534f; font-weight: 500;">{{ expense.category }}</td>
                <td style="padding: 16px 12px; color: #2c3e50; font-weight: 600;">¬£{{ "%.2f"|format(expense.amount) }}</td>
                <td style="padding: 16px 12px;">
                  <div class="payer" style="display: flex; align-items: center; gap: 8px;">
                    <div class="payer-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">
                      {{ current_user.user_name[0].upper() if current_user.user_name else 'D' }}
                    </div>
                    <span style="color: #2c3e50;">{{ current_user.user_name or 'Demo User' }}</span>
                  </div>
                </td>
                <td style="padding: 16px 12px;">
                  <div class="members-involved">
                    <span style="color: #007bff; font-weight: 500;">nnbv</span>
                    <span class="split-info" style="color: #6c757d; font-size: 13px; margin-left: 4px;">({{ expense.member_count }} people)</span>
                  </div>
                </td>
                <td style="padding: 16px 12px;">
                  <div class="expense-actions" style="display: flex; gap: 8px;">
                    <button
                      class="action-btn edit"
                      data-action="edit-expense"
                      data-expense-id="{{ expense.id }}"
                      style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px;"
                      title="Edit"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="action-btn delete"
                      data-action="delete-expense"
                      data-expense-id="{{ expense.id }}"
                      style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px; color: #dc3545;"
                      title="Delete"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
  <!-- Add Member Modal -->
  <div id="addMemberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Family Member</h3>
        <button
          class="close-btn"
          data-action="close-modal"
          data-modal-id="addMemberModal"
        >
          &times;
        </button>
      </div>
      <form
        id="addMemberForm"
        method="POST"
        action="{{ url_for('main.add_member') }}"
      >
        <div class="form-group">
          <label for="memberName">Name</label>
          <input
            type="text"
            id="memberName"
            name="name"
            required
            placeholder="Enter member name"
          />
        </div>
        <div class="form-group">
          <label for="memberRelationship">Relationship</label>
          <select id="memberRelationship" name="relationship" required>
            <option value="">Select relationship</option>
            <option value="Spouse">Spouse</option>
            <option value="Child">Child</option>
            <option value="Parent">Parent</option>
            <option value="Sibling">Sibling</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-secondary"
            data-action="cancel"
            data-modal-id="addMemberModal"
          >
            Cancel
          </button>
          <button type="submit" class="btn secondary" style="background: #6c757d; color: white; border: none;">Add Member</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Member Modal -->
  <div id="editMemberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Family Member</h3>
        <button
          class="close-btn"
          onclick="event.stopPropagation(); closeModal('editMemberModal');"
        >
          &times;
        </button>
      </div>
      <form
        id="editMemberForm"
        method="POST"
        action="{{ url_for('main.edit_member') }}"
      >
        <input type="hidden" id="editMemberId" name="member_id" />
        <div class="form-group">
          <label for="editMemberName">Name</label>
          <input type="text" id="editMemberName" name="name" required />
        </div>
        <div class="form-group">
          <label for="editMemberRelationship">Relationship</label>
          <select id="editMemberRelationship" name="relationship" required>
            <option value="Spouse">Spouse</option>
            <option value="Child">Child</option>
            <option value="Parent">Parent</option>
            <option value="Sibling">Sibling</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('editMemberModal')"
          >
            Cancel
          </button>
          <button type="submit" class="btn secondary" style="background: #6c757d; color: white; border: none;">Update Member</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div id="addExpenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Family Expense</h3>
        <button
          class="close-btn"
          onclick="event.stopPropagation(); closeModal('addExpenseModal');"
        >
          &times;
        </button>
      </div>
      <form
        id="addExpenseForm"
        method="POST"
        action="{{ url_for('main.add_family_expense') }}"
      >
        <div class="form-group">
          <label for="expenseDate">Date</label>
          <input type="date" id="expenseDate" name="expense_date" required />
        </div>
        <div class="form-group">
          <label for="expenseDescription">Description (Optional)</label>
          <input
            type="text"
            id="expenseDescription"
            name="description"
            placeholder="What was this expense for?"
          />
        </div>
        <div class="form-group">
          <label for="expenseAmount">Amount (¬£)</label>
          <input
            type="number"
            id="expenseAmount"
            name="amount"
            step="0.01"
            min="0"
            required
            placeholder="0.00"
          />
        </div>
        <div class="form-group">
          <label for="expenseCategory">Category</label>
          <select id="expenseCategory" name="category_id" required>
            <option value="">Select category</option>
            {% for category in categories %}
            <option value="{{ category.category_id }}">
              {{ category.category_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Split between:</label>
          <div class="member-checkboxes">
            <label class="checkbox-label">
              <input type="checkbox" name="include_user" value="true" checked />
              {{ current_user.user_name or 'You' }} (Owner)
            </label>
            {% for member in members %}
            <label class="checkbox-label">
              <input
                type="checkbox"
                name="member_ids"
                value="{{ member.member_id }}"
              />
              {{ member.name }}
            </label>
            {% endfor %}
          </div>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('addExpenseModal')"
          >
            Cancel
          </button>
          <button type="submit" class="btn secondary" style="background: #6c757d; color: white; border: none;">Add Expense</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Expense Modal -->
  <div id="editExpenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Family Expense</h3>
        <button
          class="close-btn"
          onclick="event.stopPropagation(); closeModal('editExpenseModal');"
        >
          &times;
        </button>
      </div>
      <form
        id="editExpenseForm"
        method="POST"
        action="{{ url_for('main.edit_family_expense') }}"
      >
        <input type="hidden" id="editExpenseId" name="expense_id" />
        <div class="form-group">
          <label for="editExpenseDate">Date</label>
          <input
            type="date"
            id="editExpenseDate"
            name="expense_date"
            required
          />
        </div>
        <div class="form-group">
          <label for="editExpenseDescription">Description (Optional)</label>
          <input
            type="text"
            id="editExpenseDescription"
            name="description"
            placeholder="What was this expense for?"
          />
        </div>
        <div class="form-group">
          <label for="editExpenseAmount">Amount (¬£)</label>
          <input
            type="number"
            id="editExpenseAmount"
            name="amount"
            step="0.01"
            min="0"
            required
            placeholder="0.00"
          />
        </div>
        <div class="form-group">
          <label for="editExpenseCategory">Category</label>
          <select id="editExpenseCategory" name="category_id" required>
            <option value="">Select category</option>
            {% for category in categories %}
            <option value="{{ category.category_id }}">
              {{ category.category_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Split between:</label>
          <div class="member-checkboxes" id="editMemberCheckboxes">
            <label class="checkbox-label">
              <input type="checkbox" name="include_user" value="true" />
              {{ current_user.user_name or 'You' }} (Owner)
            </label>
            {% for member in members %}
            <label class="checkbox-label">
              <input
                type="checkbox"
                name="member_ids"
                value="{{ member.member_id }}"
              />
              {{ member.name }}
            </label>
            {% endfor %}
          </div>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('editExpenseModal')"
          >
            Cancel
          </button>
          <button type="submit" class="btn secondary" style="background: #6c757d; color: white; border: none;">Update Expense</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Budget Modal -->
  <div id="budgetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Category Budget</h3>
        <button
          class="close-btn"
          onclick="event.stopPropagation(); closeModal('budgetModal');"
        >
          &times;
        </button>
      </div>
      <div class="budget-content">
        <form
          id="budgetForm"
          method="POST"
          action="{{ url_for('main.update_family_budget') }}"
        >
          <div class="form-group">
            <label for="categorySelect">Category</label>
            <select
              id="categorySelect"
              name="category_id"
              class="form-select"
              required
              style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #e9ecef; border-radius: 8px;"
            >
              <option value="">Select Category</option>
              {% for category in categories %}
              <option value="{{ category.category_id }}">{{ category.category_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="budgetAmount">Budget Amount (¬£)</label>
            <input
              type="number"
              id="budgetAmount"
              name="amount"
              step="0.01"
              min="0"
              required
              placeholder="Enter budget amount"
              style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #e9ecef; border-radius: 8px;"
            />
          </div>
          <div class="modal-actions" style="margin-top: 25px;">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('budgetModal')"
              style="padding: 10px 20px; border-radius: 8px;"
            >
              Cancel
            </button>
            <button type="submit" class="btn secondary" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px;">Add Budget</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Chart Data - Available globally for members.js
    const familyData = {{ category_chart_data | tojson | safe }};
    const memberData = {{ per_member_category_data | tojson | safe }};
    const familyMonthlyComparison = {{ family_monthly_comparison | default([], true) | tojson | safe }};
  </script>

  <!-- Members & Family Management JavaScript - loaded at end to ensure DOM is ready -->
  <script src="{{ url_for('static', filename='js/members.js') }}"></script>
</div>
{% endblock %}
