{% extends "base.html" %} {% block title %}Transactions - SmartExpensesTracker{%
endblock %} {% block page_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/transactions.css') }}"
/>
{% endblock %} {% block content %}
<div class="transactions-container">
  <div class="transactions-header">
    <h1>Transactions</h1>
    <div class="transaction-stats">
      <div class="stat">
        <span class="stat-label">Balance</span>
        <span class="stat-amount" id="currentBalance">£0.00</span>
      </div>
      <div class="stat">
        <span class="stat-label">This Month</span>
        <span class="stat-amount" id="monthlyTotal">£0.00</span>
      </div>
    </div>
  </div>

  <!-- Add Transaction Form -->
  <div class="add-transaction-card">
    <h3>Add New Transaction</h3>
    <form
      method="POST"
      action="{{ url_for('transactions.add_transaction') }}"
      id="transactionForm"
    >
      {{ form.hidden_tag() }}

      <div class="form-row">
        <div class="input-group">
          <label>Amount</label>
          {{ form.amount(class="form-input", placeholder="0.00", step="0.01") }}
          {% if form.amount.errors %}
          <div class="error-text">
            {% for error in form.amount.errors %}
            <small>{{ error }}</small>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="input-group">
          <label>Type</label>
          {{ form.transaction_type(class="form-select") }}
        </div>
      </div>

      <div class="form-row">
        <div class="input-group">
          <label>Category</label>
          {{ form.category_id(class="form-select") }}
          <small class="category-hint">Only required for expenses</small>
        </div>

        <div class="input-group">
          <label>Date</label>
          {{ form.transaction_date(class="form-input", type="date") }}
        </div>
      </div>

      {{ form.submit(class="btn primary") }}
    </form>
  </div>

  <!-- Transactions List -->
  <div class="transactions-list">
    <h3>Recent Transactions</h3>

    {% if transactions %}
    <div class="transactions-table">
      <div class="table-header">
        <span>Date</span>
        <span>Category</span>
        <span>Type</span>
        <span>Amount</span>
        <span>Actions</span>
      </div>

      {% for transaction in transactions %}
      <div
        class="table-row {{ 'income' if transaction.transaction_type == 'income' else 'expense' }}"
      >
        <span class="date"
          >{{ transaction.transaction_date.strftime('%d %b %Y') }}</span
        >
        <span class="category"
          >{{ transaction.category.category_name if transaction.category else
          '-' }}</span
        >
        <span class="type">{{ transaction.transaction_type.title() }}</span>
        <span
          class="amount {{ 'income' if transaction.transaction_type == 'income' else 'expense' }}"
        >
          {{ '+£' if transaction.transaction_type == 'income' else '-£' }}{{
          "%.2f"|format(transaction.amount) }}
        </span>
        <span class="actions">
          <a
            href="{{ url_for('transactions.edit_transaction', transaction_id=transaction.transaction_id) }}"
            class="btn small"
            >Edit</a
          >
          <form
            method="POST"
            action="{{ url_for('transactions.delete_transaction', transaction_id=transaction.transaction_id) }}"
            style="display: inline"
            onsubmit="return confirm('Are you sure you want to delete this transaction?');"
          >
            <input type="hidden" name="delete_confirmed" value="true" />
            <button type="submit" class="btn small danger">Delete</button>
          </form>
        </span>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <p>No transactions yet. Add your first transaction above!</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const typeSelect = document.querySelector(
      '#transactionForm select[name="transaction_type"]'
    );
    const categorySelect = document.querySelector(
      '#transactionForm select[name="category_id"]'
    );
    const categoryHint = document.querySelector(".category-hint");

    function updateCategoryField() {
      if (typeSelect.value === "income") {
        categorySelect.required = false;
        categoryHint.textContent = "Not needed for income";
        categoryHint.style.color = "#6b7280";
        // Income için kategori seçimini sıfırla
        categorySelect.value = "0";
      } else {
        categorySelect.required = true;
        categoryHint.textContent = "Required for expenses";
        categoryHint.style.color = "#ef4444";
      }
    }

    // Form submit öncesi validation
    const form = document.getElementById("transactionForm");
    form.addEventListener("submit", function (e) {
      if (
        typeSelect.value === "expense" &&
        (!categorySelect.value || categorySelect.value === "0")
      ) {
        e.preventDefault();
        alert("Please select a category for expense transactions");
        categorySelect.focus();
        return false;
      }
    });

    updateCategoryField();
    typeSelect.addEventListener("change", updateCategoryField);
    loadTransactionStats();
  });
</script>
{% endblock %}
