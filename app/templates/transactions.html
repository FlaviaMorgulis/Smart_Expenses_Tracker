{% extends "base.html" %}

{% block title %}Transactions - SmartExpensesTracker{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/transactions.css') }}">
{% endblock %}

{% block content %}
<div class="transactions-container">
    <div class="transactions-content">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1>Transaction Management üí∞</h1>
            <p class="lead">Track and manage all your income and expenses in one place</p>
        </div>

        <!-- Summary Cards - Dashboard Style -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <h3>TOTAL BALANCE</h3>
                    <h2 class="stat-amount {% if total_balance >= 0 %}positive{% else %}negative{% endif %}">
                        {% if total_balance >= 0 %}+{% else %}-{% endif %}¬£{{ "%.2f"|format(total_balance|abs) }}
                    </h2>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-info">
                    <h3>THIS MONTH</h3>
                    <h2 class="stat-amount {% if monthly_balance >= 0 %}positive{% else %}negative{% endif %}">
                        {% if monthly_balance >= 0 %}+{% else %}-{% endif %}¬£{{ "%.2f"|format(monthly_balance|abs) }}
                    </h2>
                </div>
            </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="form-section">
            <div class="section-header">
                <h3>Add New Transaction</h3>
            </div>
            
            <form method="POST" action="{{ url_for('transactions.add_transaction') }}" id="transactionForm" class="transaction-form">
                {{ form.hidden_tag() }}

                <div class="form-grid">
                    <div class="form-group">
                        <label for="amount">Amount (¬£)</label>
                        {{ form.amount(class="form-input", placeholder="0.00", step="0.01", id="amount") }}
                        {% if form.amount.errors %}
                        <div class="error-text">
                            {% for error in form.amount.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="transaction_type">Type</label>
                        {{ form.transaction_type(class="form-select", id="transaction_type") }}
                    </div>

                    <div class="form-group">
                        <label for="category_id">Category</label>
                        {{ form.category_id(class="form-select", id="category_id") }}
                        <small class="category-hint">Only required for expenses</small>
                    </div>

                    <div class="form-group">
                        <label for="transaction_date">Date</label>
                        {{ form.transaction_date(class="form-input", type="date", id="transaction_date") }}
                    </div>
                </div>

                {{ form.submit(class="btn primary") }}
            </form>
        </div>

        <!-- Transactions List -->
        <div class="transactions-section">
            <div class="section-header">
                <h3>Recent Transactions</h3>
            </div>

            {% if transactions %}
            <div class="data-table">
                <div class="table-header">
                    <span>Date</span>
                    <span>Category</span>
                    <span>Type</span>
                    <span>Amount</span>
                    <span>Actions</span>
                </div>

                {% for transaction in transactions %}
                <div class="table-row">
                    <span class="date">{{ transaction.transaction_date.strftime('%d %b %Y') }}</span>
                    <span class="category">{{ transaction.category.category_name if transaction.category else '-' }}</span>
                    <span class="type">
                        <span class="type-badge {{ transaction.transaction_type }}">
                            {{ transaction.transaction_type.title() }}
                        </span>
                    </span>
                    <span class="amount {% if transaction.transaction_type == 'income' %}positive{% else %}negative{% endif %}">
                        {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}¬£{{ "%.2f"|format(transaction.amount) }}
                    </span>
                    <span class="actions">
                        <a href="{{ url_for('transactions.edit_transaction', transaction_id=transaction.transaction_id) }}" 
                           class="btn secondary small">Edit</a>
                        <form method="POST" 
                              action="{{ url_for('transactions.delete_transaction', transaction_id=transaction.transaction_id) }}" 
                              style="display: inline"
                              onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                            <input type="hidden" name="delete_confirmed" value="true" />
                            <button type="submit" class="btn danger small">Delete</button>
                        </form>
                    </span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No transactions yet. Add your first transaction above! üìù</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const typeSelect = document.querySelector('#transactionForm select[name="transaction_type"]');
        const categorySelect = document.querySelector('#transactionForm select[name="category_id"]');
        const categoryHint = document.querySelector(".category-hint");

        function updateCategoryField() {
            if (typeSelect.value === "income") {
                categorySelect.required = false;
                categoryHint.textContent = "Not needed for income";
                categoryHint.style.color = "#6b7280";
                categorySelect.value = "";
            } else {
                categorySelect.required = true;
                categoryHint.textContent = "Required for expenses";
                categoryHint.style.color = "#ef4444";
            }
        }

        // Form submit validation
        const form = document.getElementById("transactionForm");
        form.addEventListener("submit", function (e) {
            if (typeSelect.value === "expense" && (!categorySelect.value || categorySelect.value === "")) {
                e.preventDefault();
                alert("Please select a category for expense transactions");
                categorySelect.focus();
                return false;
            }
        });

        // Initial setup
        updateCategoryField();
        typeSelect.addEventListener("change", updateCategoryField);
    });
</script>
{% endblock %}