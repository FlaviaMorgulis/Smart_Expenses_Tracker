{% extends "base.html" %}

{% block title %}Dashboard - SmartExpensesTracker{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-content">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1>Welcome back, {{ user.user_name }}! üëã</h1>
            <p class="lead">Here's your expense overview for {{ current_month }}</p>
        </div>

        <!-- Monthly Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>MONTHLY INCOME</h3>
                    <h2 class="stat-amount positive">+¬£{{ "%.2f"|format(monthly_income) }}</h2>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìâ</div>
                <div class="stat-info">
                    <h3>MONTHLY EXPENSES</h3>
                    <h2 class="stat-amount negative">-¬£{{ "%.2f"|format(monthly_expenses) }}</h2>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚öñÔ∏è</div>
                <div class="stat-info">
                    <h3>REMAINING BUDGET</h3>
                    <h2 class="stat-amount {% if remaining_budget >= 0 %}positive{% else %}negative{% endif %}">
                        ¬£{{ "%.2f"|format(remaining_budget) }}
                    </h2>
                    {% if total_budget > 0 %}
                    <small>of ¬£{{ "%.2f"|format(total_budget) }} total</small>
                    {% else %}
                    <small>No budget set</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Analytics Graphics Section -->
        <div class="analytics-section">
            <div class="analytics-header">
                <div class="time-range-selector">
                    <label>Time Range:</label>
                    <select id="timeRangeSelect" onchange="changeTimeRange(this.value)">
                        <option value="3months" {% if current_time_range == '3months' %}selected{% endif %}>Last 3 Months</option>
                        <option value="6months" {% if current_time_range == '6months' %}selected{% endif %}>Last 6 Months</option>
                        <option value="1year" {% if current_time_range == '1year' %}selected{% endif %}>Last 1 Year</option>
                        <option value="2years" {% if current_time_range == '2years' %}selected{% endif %}>Last 2 Years</option>
                        <option value="all" {% if current_time_range == 'all' %}selected{% endif %}>All Time</option>
                    </select>
                </div>
            </div>
            
            <div class="analytics-grid">
                <!-- Pie Chart - Monthly Category Spending -->
                <div class="analytics-card">
                    <h4>
                        Spending Breakdown 
                        <small>
                            {% if current_time_range == '3months' %}
                                - Last 3 Months
                            {% elif current_time_range == '6months' %}
                                - Last 6 Months
                            {% elif current_time_range == '1year' %}
                                - Last 1 Year
                            {% elif current_time_range == '2years' %}
                                - Last 2 Years
                            {% elif current_time_range == 'all' %}
                                - All Time
                            {% else %}
                                - {{ current_month }}
                            {% endif %}
                        </small>
                    </h4>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                
                <!-- Monthly Comparison Chart -->
                <div class="analytics-card">
                    <h4>Income vs Expenses 
                        <small>({{ monthly_comparison|length }} months)</small>
                    </h4>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Alerts Section -->
<div class="budget-alerts-section">
    <div class="section-header">
        <h3>Personal Budget Alerts - {{ current_month }}</h3>
        <a href="{{ url_for('main.budget') }}" class="view-all">Manage Personal Budgets</a>
    </div>
    
    <div class="budget-alerts-container" id="budgetAlertsSlider">
        {% if budget_alerts %}
            {% set alert_list = [] %}
            {% for alert in budget_alerts %}
                {% set spent = alert.spent %}
                {% set budget_amount = alert.budget_amount %}
                {% set percentage = (spent / budget_amount * 100) if budget_amount > 0 else 0 %}
                {% set alert_level = 'over-budget' if percentage >= 100 else ('near-limit' if percentage >= 75 else 'within-budget') %}
                {% set _ = alert_list.append((alert.category_name, budget_amount, spent, percentage, alert_level)) %}
            {% endfor %}
            
            {% set sorted_alerts = alert_list|sort(attribute='3', reverse=True) %}
            
            {% for category_name, budget_amount, spent, percentage, alert_level in sorted_alerts %}
            <div class="budget-alert {{ alert_level }}">
                <div class="alert-category">{{ category_name }}</div>
                <div class="alert-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ percentage }}%"></div>
                    </div>
                    <span class="progress-text">{{ "%.1f"|format(percentage) }}%</span>
                </div>
                <div class="alert-amount">¬£{{ "%.2f"|format(spent) }} / ¬£{{ "%.2f"|format(budget_amount) }}</div>
                <div class="alert-status">
                    {% if alert_level == 'over-budget' %}
                        Over Budget
                    {% elif alert_level == 'near-limit' %}
                        Near Limit
                    {% else %}
                        Within Budget
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-alerts">
                <p>No personal budget alerts. All good! ‚úÖ</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function changeTimeRange(range) {
    const url = new URL(window.location.href);
    url.searchParams.set('range', range);
    window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    // Monthly Category Spending Pie Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    
    const categoryData = {
        labels: [
            {% for category, amount in category_spending.items() %}
                '{{ category }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for category, amount in category_spending.items() %}
                    {{ amount }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#C9CBCF', '#FF6384'
            ]
        }]
    };

    if (categoryData.labels.length > 0) {
        new Chart(categoryCtx, {
            type: 'pie',
            data: categoryData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ¬£${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } else {
        categoryCtx.font = '14px Arial';
        categoryCtx.fillStyle = '#666';
        categoryCtx.textAlign = 'center';
        categoryCtx.fillText('No spending data for {{ current_month }}', 200, 150);
    }

    // Monthly Comparison Line Chart
    const monthlyCtx = document.getElementById('monthlyComparisonChart').getContext('2d');
    
    const monthlyData = {
        labels: [
            {% for month_data in monthly_comparison %}
                '{{ month_data.month_short }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [
            {
                label: 'Income',
                data: [
                    {% for month_data in monthly_comparison %}
                        {{ month_data.income }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            },
            {
                label: 'Expenses',
                data: [
                    {% for month_data in monthly_comparison %}
                        {{ month_data.expenses }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }
        ]
    };

    if (monthlyData.labels.length > 0) {
        new Chart(monthlyCtx, {
            type: 'line',
            data: monthlyData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '¬£' + value;
                            }
                        }
                    }
                }
            }
        });
    } else {
        monthlyCtx.font = '14px Arial';
        monthlyCtx.fillStyle = '#666';
        monthlyCtx.textAlign = 'center';
        monthlyCtx.fillText('No monthly comparison data available', 200, 150);
    }
});
</script>

{% endblock %}