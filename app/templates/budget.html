{% extends "base.html" %} {% block title %}Budget - SmartExpensesTracker{%
endblock %} {% block head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/budget.css') }}"
/>
{% endblock %} {% block content %}
<div class="dashboard-container">
  <!-- Welcome Section -->
    <div class="welcome-section">
      <h1>Budget Management 💰</h1>
      <p class="lead">Take control of your spending with smart budgeting</p>
    </div>

    <!-- Monthly Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">💳</div>
        <div class="stat-info">
          <h3>TOTAL BUDGET</h3>
          <h2 class="stat-amount">£{{ "%.2f"|format(total_budget) }}</h2>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">📉</div>
        <div class="stat-info">
          <h3>SPENT THIS MONTH</h3>
          <h2 class="stat-amount negative">
            £{{ "%.2f"|format(monthly_spent) }}
          </h2>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">💰</div>
        <div class="stat-info">
          <h3>REMAINING</h3>
          <h2
            class="stat-amount {{ 'positive' if remaining_budget > 0 else 'negative' }}"
          >
            £{{ "%.2f"|format(remaining_budget) }}
          </h2>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">📊</div>
        <div class="stat-info">
          <h3>BUDGET USED</h3>
          <h2
            class="stat-amount {{ 'warning' if budget_percentage >= 75 else 'positive' }}"
          >
            {{ "%.1f"|format(budget_percentage) }}%
          </h2>
        </div>
      </div>
    </div>

    <!-- Budget Progress Section -->
    <div class="analytics-section">
      <div class="analytics-card">
        <h4>Monthly Progress</h4>
        <p class="analytics-subtitle">
          {{ "%.1f"|format(budget_percentage) }}% of budget used
        </p>
        <div class="progress-container">
          <div class="progress-bar">
            <div
              class="progress-fill"
              style="width: {{ budget_percentage|round(0) }}%"
            ></div>
          </div>
          <div class="progress-details">
            <span
              >£{{ "%.2f"|format(monthly_spent) }} spent of £{{
              "%.2f"|format(total_budget) }} budget</span
            >
          </div>
        </div>
      </div>
    </div>
    <!-- Category Budgets Section -->
    <div class="analytics-section">
      <div class="analytics-card full-width">
        <div class="analytics-header">
          <h4>Category Budgets</h4>
          <button
            class="btn secondary"
            data-action="add-budget"
            onclick="openAddModal()"
            style="background: #6c757d; color: white; border: none"
          >
            <i class="icon"></i> Add Budget
          </button>
        </div>

        <div class="budget-cards-grid">
          {% if category_spending %} {# Create a list of tuples with category
          data and sort by percentage (highest first) #} {% set budget_list = []
          %} {% for category_name, data in category_spending.items() %} {% if
          data.budget > 0 %} {% set _ = budget_list.append((category_name,
          data.budget, data.spent, data.percentage)) %} {% endif %} {% endfor %}
          {# Sort by percentage descending (red to green) #} {% set
          sorted_budgets = budget_list|sort(attribute='3', reverse=True) %} {%
          for category_name, budget_amount, spent, percentage in sorted_budgets
          %} {% set progress_class = 'critical-level' if percentage >= 90 else
          ('warning-level' if percentage >= 75 else 'good-level') %} {% set
          alert_class = 'critical' if percentage >= 90 else ('warning' if
          percentage >= 75 else 'good') %}

          <div class="category-card">
            <div class="category-header">
              <h3>{{ category_name }}</h3>
              <div class="category-actions">
                <button
                  class="btn-icon"
                  onclick="openEditModal({{ loop.index }}, '{{ category_name }}', {{ budget_amount }})"
                  title="Edit"
                >
                  ✏️
                </button>
                <button
                  class="btn-icon delete"
                  onclick="deleteBudget({{ loop.index }}, '{{ category_name }}')"
                  title="Delete"
                >
                  🗑️
                </button>
              </div>
            </div>
            <div class="category-amount">
              £{{ "%.0f"|format(budget_amount) }}
            </div>
            <div class="category-progress">
              <div class="progress-bar small">
                <div
                  class="progress-fill {{ progress_class }}"
                  style="width: {{ percentage|round(0) }}%"
                ></div>
              </div>
              <div class="progress-text">
                <span>£{{ "%.0f"|format(spent) }} spent</span>
                <span>{{ "%.0f"|format(percentage) }}%</span>
              </div>
            </div>
            <div class="category-alert {{ alert_class }}">
              {% if percentage >= 90 %} 🚨 {{ "%.0f"|format(percentage) }}% -
              Critical! Near limit! {% elif percentage >= 75 %} ⚠️ {{
              "%.0f"|format(percentage) }}% - Monitor spending {% else %} ✅ {{
              "%.0f"|format(percentage) }}% - Well managed! {% endif %}
            </div>
          </div>
          {% endfor %} {% else %}
          <p style="color: #6c757d; padding: 20px; text-align: center">
            No budgets configured yet. Click "Add Budget" to create your first
            budget.
          </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Budget Modal -->
<div id="addBudgetModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Budget</h3>
      <span class="modal-close" onclick="closeAddModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="addBudgetForm">
        <div class="input-group">
          <label for="add_category">Category</label>
          <select
            id="add_category"
            name="category_id"
            class="form-select"
            required
          >
            <option value="">Select Category</option>
            <option value="1">Transport</option>
            <option value="2">Utilities</option>
            <option value="3">Entertainment</option>
            <option value="4">Food</option>
            <option value="5">Healthcare</option>
            <option value="6">Shopping</option>
            <option value="7">Other</option>
          </select>
        </div>
        <div class="input-group">
          <label for="add_amount">Budget Amount (£)</label>
          <input
            type="number"
            id="add_amount"
            name="amount"
            class="form-input"
            step="0.01"
            min="0"
            required
          />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" onclick="closeAddModal()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Budget</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Budget Modal -->
<div id="editBudgetModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Budget</h3>
      <span class="modal-close" onclick="closeEditModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editBudgetForm">
        <input type="hidden" id="edit_budget_id" name="budget_id" />
        <div class="input-group">
          <label for="edit_category">Category</label>
          <input type="text" id="edit_category" class="form-input" readonly />
        </div>
        <div class="input-group">
          <label for="edit_amount">Budget Amount (£)</label>
          <input
            type="number"
            id="edit_amount"
            name="amount"
            class="form-input"
            step="0.01"
            min="0"
            required
          />
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn secondary"
            onclick="closeEditModal()"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Update Budget</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Sort category cards by alert level (critical first, then warning, then good)
    const categoryGrid = document.querySelector(".category-grid");
    if (categoryGrid) {
      const cards = Array.from(categoryGrid.querySelectorAll(".category-card"));

      // Sort cards by priority: critical (3), warning (2), good/no-alert (1)
      cards.sort((a, b) => {
        const getPriority = (card) => {
          if (card.querySelector(".category-alert.critical")) return 3;
          if (card.querySelector(".category-alert.warning")) return 2;
          return 1;
        };

        return getPriority(b) - getPriority(a); // Descending order
      });

      // Reappend cards in sorted order
      cards.forEach((card) => categoryGrid.appendChild(card));
    }

    const statCards = document.querySelectorAll(".stat-card");
    statCards.forEach((card, index) => {
      card.style.opacity = "0";
      card.style.transform = "translateY(20px)";
      setTimeout(() => {
        card.style.transition = "all 0.4s ease";
        card.style.opacity = "1";
        card.style.transform = "translateY(0)";
      }, index * 100);
    });

    const categoryCards = document.querySelectorAll(".category-card");
    categoryCards.forEach((card, index) => {
      card.style.opacity = "0";
      card.style.transform = "translateY(15px)";
      setTimeout(() => {
        card.style.transition = "all 0.3s ease";
        card.style.opacity = "1";
        card.style.transform = "translateY(0)";
      }, 300 + index * 50);
    });
  });

  // Modal Functions
  function openAddModal() {
    document.getElementById("addBudgetModal").style.display = "block";
  }

  function closeAddModal() {
    document.getElementById("addBudgetModal").style.display = "none";
    document.getElementById("addBudgetForm").reset();
  }

  function openEditModal(budgetId, category, amount, period) {
    document.getElementById("edit_budget_id").value = budgetId;
    document.getElementById("edit_category").value = category;
    document.getElementById("edit_amount").value = amount;
    document.getElementById("edit_period").value = period;
    document.getElementById("editBudgetModal").style.display = "block";
  }

  function closeEditModal() {
    document.getElementById("editBudgetModal").style.display = "none";
    document.getElementById("editBudgetForm").reset();
  }

  function deleteBudget(budgetId, category) {
    if (
      !confirm(`Are you sure you want to delete the budget for ${category}?`)
    ) {
      return;
    }

    fetch(`/budget/${budgetId}/delete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch((error) => {
        alert("Error deleting budget: " + error);
      });
  }

  // Close modals when clicking outside
  window.onclick = function (event) {
    const addModal = document.getElementById("addBudgetModal");
    const editModal = document.getElementById("editBudgetModal");
    if (event.target == addModal) {
      closeAddModal();
    }
    if (event.target == editModal) {
      closeEditModal();
    }
  };

  // Form submission handlers
  document.addEventListener("DOMContentLoaded", function () {
    document
      .getElementById("addBudgetForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {
          category_id: formData.get("category_id"),
          amount: formData.get("amount"),
        };

        fetch("/budget/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert(data.message);
              closeAddModal();
              location.reload();
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch((error) => {
            alert("Error adding budget: " + error);
          });
      });

    document
      .getElementById("editBudgetForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const budgetId = document.getElementById("edit_budget_id").value;
        const formData = new FormData(this);
        const data = {
          amount: formData.get("amount"),
        };

        fetch(`/budget/${budgetId}/edit`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert(data.message);
              closeEditModal();
              location.reload();
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch((error) => {
            alert("Error updating budget: " + error);
          });
      });
  });
</script>
</div>
{% endblock %}
